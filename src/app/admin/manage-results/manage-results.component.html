<div *ngIf="loading" class="loading-overlay">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<section class="admin-manage-results py-5">
  <div class="container shadow-sm rounded bg-light p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
      <h2 class="fw-bold text-dark">ðŸ“Š Manage Results</h2>
      <div class="d-flex flex-wrap gap-2">
        <select class="form-select rounded-pill" [(ngModel)]="filter.class" (change)="filterResults()">
          <option value="">All Classes</option>
          <option *ngFor="let c of classList">{{ c }}</option>
        </select>
        <select class="form-select rounded-pill" [(ngModel)]="filter.term" (change)="filterResults()">
          <option value="">All Terms</option>
          <option>1st Term</option>
          <option>2nd Term</option>
          <option>3rd Term</option>
        </select>
        <select class="form-select rounded-pill" [(ngModel)]="filter.session" (change)="filterResults()">
          <option value="">All Sessions</option>
          <option *ngFor="let s of sessionList">{{ s }}</option>
        </select>
        <input type="text" class="form-control rounded-pill" placeholder="Search name or admission no."
          [(ngModel)]="filter.search" (input)="filterResults()" />
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle text-center bg-white shadow-sm rounded">
        <thead class="table-primary">
          <tr>
            <th>#</th>
            <th>Full Name</th>
            <th>Admission No.</th>
            <th>Class</th>
            <th>Term</th>
            <th>Session</th>
            <th>Total</th>
            <th>%</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let result of filteredResults; let i = index" class="table-row-hover">
            <td>{{ i + 1 }}</td>

            <!-- Full Name -->
            <td *ngIf="editIndex !== i">{{ result.fullName }}</td>
            <td *ngIf="editIndex === i">
              <input [(ngModel)]="editResult.fullName" class="form-control form-control-sm" />
            </td>

            <!-- Admission No. -->
            <td *ngIf="editIndex !== i">{{ result.admissionNumber }}</td>
            <td *ngIf="editIndex === i">
              <input [(ngModel)]="editResult.admissionNumber" class="form-control form-control-sm" />
            </td>

            <!-- Class -->
            <td *ngIf="editIndex !== i">{{ result.class }}</td>
            <td *ngIf="editIndex === i">
              <input [(ngModel)]="editResult.class" class="form-control form-control-sm" />
            </td>

            <!-- Term -->
            <td *ngIf="editIndex !== i">{{ result.term }}</td>
            <td *ngIf="editIndex === i">
              <input [(ngModel)]="editResult.term" class="form-control form-control-sm" />
            </td>

            <!-- Session -->
            <td *ngIf="editIndex !== i">{{ result.session }}</td>
            <td *ngIf="editIndex === i">
              <input [(ngModel)]="editResult.session" class="form-control form-control-sm" />
            </td>

            <!-- Total Score -->
            <td *ngIf="editIndex !== i">{{ result.totalScore }}</td>
            <td *ngIf="editIndex === i">
              <input type="number" [(ngModel)]="editResult.totalScore" class="form-control form-control-sm" />
            </td>

            <!-- Percentage -->
            <td *ngIf="editIndex !== i">{{ result.percentage | number:'1.0-2' }}%</td>
            <td *ngIf="editIndex === i">
              <input type="number" [(ngModel)]="editResult.percentage" class="form-control form-control-sm" />
            </td>

            <!-- Actions -->
            <td>
              <div *ngIf="editIndex !== i" class="d-flex justify-content-center gap-2">
                <button class="btn btn-outline-info btn-sm" (click)="startEdit(i)">Edit</button>
                <button class="btn btn-outline-danger btn-sm" (click)="deleteResult(result)">Delete</button>
              </div>
              <div *ngIf="editIndex === i" class="d-flex justify-content-center gap-2">
                <button class="btn btn-success btn-sm" (click)="saveEdit(result)">Save</button>
                <button class="btn btn-secondary btn-sm" (click)="cancelEdit()">Cancel</button>
              </div>
            </td>
          </tr>

          <tr *ngIf="filteredResults.length === 0">
            <td colspan="9" class="text-center text-muted py-3">No results found.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
